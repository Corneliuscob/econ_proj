/*!
 * Start Bootstrap - New Age v5.0.3 (https://startbootstrap.com/template-overviews/new-age)
 * Copyright 2013-2019 Start Bootstrap
 * Licensed under MIT (https://github.com/BlackrockDigital/startbootstrap-new-age/blob/master/LICENSE)
 */

var camera,scene,renderer,controls,root,objects=[],tmpVec1=new THREE.Vector3,tmpVec2=new THREE.Vector3,tmpVec3=new THREE.Vector3,tmpVec4=new THREE.Vector3,visualizationType=2,MOLECULES={},loader=new THREE.PDBLoader,colorSpriteMap={},baseSprite=document.createElement("img"),menu=document.getElementById("menu");function init(){(camera=new THREE.PerspectiveCamera(70,window.innerWidth/window.innerHeight,1,5e3)).position.z=700,scene=new THREE.Scene,root=new THREE.Object3D,scene.add(root),(renderer=new THREE.CSS3DRenderer).setSize(window.innerWidth,window.innerHeight),document.getElementById("animation-container").appendChild(renderer.domElement),baseSprite.onload=function(){loadMolecule("models/molecules/h2so4.pdb")},baseSprite.src="textures/sprites/ball.png",window.addEventListener("resize",onWindowResize,!1)}function colorify(e,t,o,r,n){for(var a=r.r,i=r.g,c=r.b,d=e.getImageData(0,0,t,o),s=d.data,p=0;p<o;p++)for(var m=0;m<t;m++){var l=4*(p*t+m);s[l]*=a,s[l+1]*=i,s[l+2]*=c,s[l+3]*=n}e.putImageData(d,0,0)}function imageToCanvas(e){var t=e.width,o=e.height,r=document.createElement("canvas");return r.width=t,r.height=o,r.getContext("2d").drawImage(e,0,0,t,o),r}function loadMolecule(e){for(var t=0;t<objects.length;t++){var o=objects[t];o.parent.remove(o)}objects=[],loader.load(e,function(e,t){var o=e.center();t.translate(o.x,o.y,o.z);for(var r=e.getAttribute("position"),n=e.getAttribute("color"),a=new THREE.Vector3,i=new THREE.Color,c=0;c<r.count;c++){a.x=r.getX(c),a.y=r.getY(c),a.z=r.getZ(c),i.r=n.getX(c),i.g=n.getY(c),i.b=n.getZ(c);var d=e.elements[c];if(!colorSpriteMap[d]){var s=imageToCanvas(baseSprite);colorify(s.getContext("2d"),s.width,s.height,i,1);var p=s.toDataURL();colorSpriteMap[d]=p}var m=colorSpriteMap[d],l=document.createElement("img");l.src=m,(v=new THREE.CSS3DSprite(l)).position.copy(a),v.position.multiplyScalar(75),v.matrixAutoUpdate=!1,v.updateMatrix(),root.add(v),objects.push(v)}r=t.getAttribute("position");var u=new THREE.Vector3,E=new THREE.Vector3;for(c=0;c<r.count;c+=2){u.x=r.getX(c),u.y=r.getY(c),u.z=r.getZ(c),E.x=r.getX(c+1),E.y=r.getY(c+1),E.z=r.getZ(c+1),u.multiplyScalar(75),E.multiplyScalar(75),tmpVec1.subVectors(E,u);var g=tmpVec1.length()-50;(w=document.createElement("div")).className="bond",w.style.height=g+"px",(v=new THREE.CSS3DObject(w)).position.copy(u),v.position.lerp(E,.5),v.userData.bondLengthShort=g+"px",v.userData.bondLengthFull=g+55+"px";var w,h=tmpVec2.set(0,1,0).cross(tmpVec1),x=Math.acos(tmpVec3.set(0,1,0).dot(tmpVec4.copy(tmpVec1).normalize())),b=(new THREE.Matrix4).makeRotationAxis(h.normalize(),x);v.matrix=b,v.rotation.setFromRotationMatrix(v.matrix,v.rotation.order),v.matrixAutoUpdate=!1,v.updateMatrix(),root.add(v),objects.push(v),(w=document.createElement("div")).className="bond",w.style.height=g+"px";var v,S=new THREE.Object3D(w);S.position.copy(u),S.position.lerp(E,.5),S.matrix.copy(b),S.rotation.setFromRotationMatrix(S.matrix,S.rotation.order),S.matrixAutoUpdate=!1,S.updateMatrix(),(v=new THREE.CSS3DObject(w)).rotation.y=Math.PI/2,v.matrixAutoUpdate=!1,v.updateMatrix(),v.userData.bondLengthShort=g+"px",v.userData.bondLengthFull=g+55+"px",(v.userData.joint=S).add(v),root.add(S),objects.push(v)}render()})}function onWindowResize(){camera.aspect=window.innerWidth/window.innerHeight,camera.updateProjectionMatrix(),renderer.setSize(window.innerWidth,window.innerHeight),render()}function animate(){requestAnimationFrame(animate);var e=4e-4*Date.now();root.rotation.x=e,root.rotation.y=.7*e,render()}function render(){renderer.render(scene,camera)}init(),animate();